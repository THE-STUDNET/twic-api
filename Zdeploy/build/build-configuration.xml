<?xml version="1.0" encoding="UTF-8"?>
<project default="configuration">
    <target name="configuration">
        <echo msg="Building configuration..." />
        	<delete dir="${tmp.basedir}" includeemptydirs="true" quiet="true" />
		<mkdir dir="${tmp.basedir}" />
		<copy todir="${tmp.basedir}" overwrite="true" >
        	<fileset dir="${project.basedir}">
            	<include name="**" />
                <exclude name="**/*Test*"/>
                <exclude name="**/*.dist"/>
                <exclude name="**/*.build"/>
                <exclude name="tests/**"/>
                <exclude name="utils/**"/>
                <exclude name="phpunit.xml"/>
                <exclude name="composer.lock"/>
                <exclude name="build/**"/>
                <exclude name="data/db/**"/>
                <exclude name="Zdeploy/**"/>
                <exclude name="build.xml"/>
                <exclude name="deploy-db-*"/>
                <exclude name="undo-db-*"/>
                <exclude name="vendor/**"/>
                <exclude name="/config/autoload/**"/>
                <exclude name="**/*.md"/>
                <exclude name="**/*.mwb"/>
                <exclude name="composer.lock"/>
                <exclude name=".*/**"/>
                <exclude name=".*"/>
        	</fileset>
        </copy>
        <echo msg="Composer install" />
        	<composer command="update" composer="/usr/bin/composer.phar">
				<arg value="--optimize-autoloader" />
        		<arg value="--classmap-authoritative" />
	   			<arg value="--working-dir=${tmp.basedir}" />
	   			<arg value="--no-dev" />
        		<arg value="-q" />
        	</composer>

        <echo msg="generate autoload" />
		<exec command="./create-autoload.sh"
        	  dir="${tmp.basedir}/bin/"
              checkreturn="true" />

        <echo msg="copy config" />
    	<copy todir="${tmp.basedir}/config/autoload/" overwrite="true">
	        <filelist dir="${project.basedir}/config/autoload/" files="local.php.build" />
	        <filelist dir="${project.basedir}/config/autoload/" files="global.php.build" />
	        <mapper type="regexp" from="^(.*).build$" to="\1"/>
	        <filterchain>
	            <expandproperties />
	        </filterchain>
    	</copy>
	    <delete includeemptydirs="true">
	    	<fileset dir="${tmp.basedir}/">
	        	<include name="composer.*" />
	        	<include name=".*" />
	        	<include name=".*/**" />
	        	<include name="bin/**" />
	        </fileset>
	    </delete>

    	<if>
    		<not>
    	    	<available file='${dms.uploaddir}' type='dir' />
    		</not>
    	    <then>
    	    	<mkdir dir="${dms.uploaddir}" />
    	    </then>
    	</if>
    </target>

    <target name="create-targz">
		<tar
  			destfile="${tmp.basedir}/${phing.project.name}-${git.rev}.tar.gz"
 			compression="gzip">
  			<fileset dir="${tmp.basedir}/${git.rev}/">
   				<include name="*" />
  			</fileset>
 		</tar>
		<delete
  			dir="${tmp.basedir}/${git.rev}/"
  			includeemptydirs="true"
  			verbose="false"
  			failonerror="true" />
    </target>

	<target name="restart-service">
		<echo msg="restart apache" />
		<exec command="service ${apache.servicename} restart" checkreturn="true" />

		<echo msg="restart memcache" />
		<exec command="service memcached restart" checkreturn="true" />
	</target>

	<target name="chown">
		<echo msg="chown apache" />
		<exec command="chown -R ${apache.username}:${apache.username} ${tmp.basedir}" checkreturn="true" />
		<exec command="chmod -R 775 ${tmp.basedir}" checkreturn="true" />
	</target>

</project>
